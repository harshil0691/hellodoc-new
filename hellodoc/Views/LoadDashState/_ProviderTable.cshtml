@model hellodoc.DbEntity.ViewModels.AdminParent
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor


<div class="table-responsive d-none d-sm-none d-md-block d-lg-block d-xl-block newtable">
    <table style="width:100%;z-index:5">
        <thead>
            <tr>
                <th class="p-3">Name</th>
                <th>Phone</th>
                <th>Address</th>
                @{
                    if(Model.RequestStatus == "active")
                    {
                        <th>Status</th>
                    }
                }
                <th>Actions</th>
            </tr>
        </thead>
        <tbody style="font-size:larger;font-weight:400;color:white;">
            @{
                foreach (var a in Model.adminDashModels)
                {
                    var reqcolor = "";
                    var text = "";

                    if (a.Requesttypeid == 1)
                    {
                        reqcolor = "#d23636";
                        text = "Business";
                    }
                    else if (a.Requesttypeid == 2)
                    {
                        reqcolor = "#418441";
                        text = "Patient";
                    }
                    else if (a.Requesttypeid == 3)
                    {
                        reqcolor = "#ecb728";
                        text = "Family/Friend";
                    }
                    else if (a.Requesttypeid == 4)
                    {
                        reqcolor = "#14428ffa";
                        text = "Concierge";
                    }

                    <tr class="m-2" style="background-color:@reqcolor">
                        <td class="p-3">@a.PatientName </td>
                        <td>
                            @{
                                if (a.Phonenumber_P != null)
                                {
                                    <button class="btn btn-outline-light">@a.Phonenumber_P</button> <br />
                                    <span>(patient)</span> <br />
                                }
                                if (a.Phonenumber_R != null && a.Requesttypeid != 2)
                                {
                                    <button class="btn btn-outline-light">@a.Phonenumber_R</button> <br />
                                    <span>(@text)</span> <br />
                                }
                            }
                        </td>
                        <td>@a.Address</td>
                        @{
                            if (Model.RequestStatus == "active")
                            {
                                if (a.CallType == "HouseCall")
                                {
                                    <td><button class="btn btn-info text-white p-2">Housecall</button></td>
                                }else if (a.CallType == "Consult")
                                {
                                    <td><button class="btn btn-info text-white p-2">Consult</button></td>
                                }
                                else
                                {
                                    <td>-</td>
                                }
                            }
                        }
                        <td>
                            <div class="dropdown">
                                <button class="btn btn-outline-light" dropdown-toggle p-1" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    Actions
                                </button>
                                <ul class="dropdown-menu" style="position:fixed;transform: translate(-4px, 6px);">
                                    @{
                                        if(Model.RequestStatus == "new")
                                        {
                                            <li><button type="button" class="dropdown-item " onclick="adminDashload({controller: 'ProviderDashboard',actionType:'AcceptRequest',requestid :'@a.Requestid',id: 'dashboard'})"><i class="bi bi-journal-check me-2"></i>Accept</button></li>
                                            <li><button class="dropdown-item" onclick="loadActionView({ActionType:'ViewCase',requestid :@a.Requestid,bcolor:'@reqcolor',btext:'@text'})"><i class="bi bi-journal-text me-2"></i>View Case</button></li>
                                            <li><button class="dropdown-item" onclick="loadActionView({ActionType:'ViewNotes',requestid :@a.Requestid})"><i class="bi bi-journals me-2"></i>View Notes</button></li>
                                        }else if (Model.RequestStatus == "pending")
                                        {
                                            <li><button type="button" class="dropdown-item " onclick="ShowModal({ActionType:'SendAgreement',patientName :'@a.PatientName',requestid :@a.Requestid, email : '@a.Email',phonenumber : '@a.Phonenumber_P',bcolor : '@reqcolor',btext:'@text'})"><i class="bi bi-card-heading me-2"></i>Send Aggrement</button></li>
                                            <li><a class="dropdown-item" onclick="loadActionView({ActionType:'ViewCase',requestid :@a.Requestid,bcolor:'@reqcolor',btext:'@text'})"><i class="bi bi-journal-text me-2"></i>View Case</a></li>
                                            <li><button class="dropdown-item" onclick="loadActionView({ActionType:'ViewUploads',requestid :'@a.Requestid'})"><i class="bi bi-file-earmark-arrow-up me-2"></i>View Uploads</button></li>
                                            <li><button class="dropdown-item" onclick="loadActionView({ActionType:'ViewNotes',requestid :@a.Requestid})"><i class="bi bi-journals me-2"></i>View Notes</button></li>
                                            <li><button type="button" class="dropdown-item " onclick="ShowModal({ActionType:'transfertoadmin',requestid :@a.Requestid})"><i class="bi bi-card-text me-2"></i>Transfer</button></li>
                                        }else if (Model.RequestStatus == "active")
                                        {
                                            <li><button class="dropdown-item" onclick="loadActionView({ActionType:'ViewCase',requestid :@a.Requestid,bcolor:'@reqcolor',btext:'@text'})"><i class="bi bi-journal-text me-2"></i>View Case</button></li>
                                            <li><button class="dropdown-item" onclick="loadActionView({ActionType:'ViewUploads',requestid :'@a.Requestid'})"><i class="bi bi-file-earmark-arrow-up me-2"></i>View Uploads</button></li>
                                            <li><button class="dropdown-item" onclick="loadActionView({ActionType:'ViewNotes',requestid :@a.Requestid})"><i class="bi bi-journals me-2"></i>View Notes</button></li>
                                            <li><button class="dropdown-item" onclick="loadActionView({ActionType:'Orders',requestid :@a.Requestid})"><i class="bi bi-box-seam me-2"></i>Orders</button></li>
                                            <li><button class="dropdown-item" onclick="ShowModal({actionType:'encounter',requestid :@a.Requestid})"><i class="bi bi-card-text me-2"></i>Encounter</button></li>
                                        }
                                        else if(Model.RequestStatus == "conclude")
                                        {
                                            <li><button class="dropdown-item" onclick="loadActionView({ActionType:'ConcludeCare',requestid :@a.Requestid})"><i class="bi bi-journal-text me-2"></i>Conclude Care</button></li>
                                            <li><button class="dropdown-item" onclick="loadActionView({ActionType:'ViewCase',requestid :@a.Requestid,bcolor:'@reqcolor',btext:'@text'})"><i class="bi bi-journal-text me-2"></i>View Case</button></li>
                                            <li><button class="dropdown-item" onclick="loadActionView({ActionType:'ViewUploads',requestid :'@a.Requestid'})"><i class="bi bi-file-earmark-arrow-up me-2"></i>View Uploads</button></li>
                                            <li><button class="dropdown-item" onclick="loadActionView({ActionType:'ViewNotes',requestid :@a.Requestid})"><i class="bi bi-journals me-2"></i>View Notes</button></li>
                                            <li><button class="dropdown-item" onclick="loadActionView({ActionType:'EncounterForm',requestid :@a.Requestid})"><i class="bi bi-card-text me-2"></i>Encounter</button></li>
                                        }
                                    }
                                    
                                </ul>

                            </div>
                        </td>

                    </tr>
                }
            }

        </tbody>
    </table>

</div>


<div class="d-block d-sm-block d-md-none d-lg-none d-xl-none">
    <div class="accordion" id="accordionExample">

        @{
            foreach (var a in Model.adminDashModels)
            {
                var reqcolor = "";
                var text = "";

                if (a.Requesttypeid == 1)
                {
                    reqcolor = "bg-danger";
                    text = "Business";
                }
                else if (a.Requesttypeid == 2)
                {
                    reqcolor = "bg-success";
                    text = "Patient";
                }
                else if (a.Requesttypeid == 3)
                {
                    reqcolor = "bg-warning";
                    text = "Family/Friend";
                }
                else if (a.Requesttypeid == 4)
                {
                    reqcolor = "bg-primary";
                    text = "Concierge";
                }
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed  d-grid" type="button" data-bs-toggle="collapse" data-bs-target="#collapse_@a.Requestid" aria-expanded="true" aria-controls="collapse_@a.Requestid">
                            <div class="d-flex justify-content-between w-100 m-2">
                                <div>@a.PatientName</div>
                                <div class="d-flex">@text<div class="colored-dot @reqcolor m-1 mx-2"></div> </div>
                            </div>
                            <div class="d-flex justify-content-between w-100 m-2">
                                <div>@a.Address</div>
                                <a class="btn btn-outline-info rounded-5">Map Location</a>
                            </div>
                            <div><i class="bi bi-clock text-info px-2"></i> Wait time :<b> @a.Createddate </b></div>

                        </button>

                    </h2>

                    <div id="collapse_@a.Requestid" class="accordion-collapse collapse" data-bs-parent="#accordionExample" style="background-color:#d7ffffde;">
                        <div class="d-flex justify-content-end" style="top:0;"><button class="btn bg-light rounded-5 px-3" style="color:mediumpurple;border:2px solid mediumpurple;position:relative;top:-18px;z-index:10;">View Case</button></div>
                        <div class="accordion-body">

                            <div class="mb-2"><i class="bi rounded-pill btn btn-outline-info text-black-50 bi-calendar3  px-2"></i> Date Of Birth :<b> @a.Createddate </b></div>
                            <div class="mb-2"><i class="bi bi-envelope-at rounded-pill btn btn-outline-info text-black-50 px-2"></i> Email :<b> @a.Email </b></div>
                            <div class="mb-2"><i class="bi bi-telephone rounded-pill btn btn-outline-info text-black-50 px-2"></i> @text :<b> @a.Phonenumber_P </b></div>
                            <div class="mb-2"><i class="bi bi-person-circle rounded-pill btn btn-outline-info text-black-50 px-2"></i> Requestor :<b> @a.RequestorName </b></div>
                            <div class="row">
                                <button class="btn text-white rounded-5 col-5 m-2 mx-3" style="background-color:mediumpurple;" onclick="ShowModal({ActionType:'AssignCase',requestid :@a.Requestid,patientName :'Assign'})">Assign Case</button>
                                <button type="button" class="btn btn-danger rounded-5 col-5 m-2 mx-3 " onclick="ShowModal({ActionType:'CancelCase',requestid :@a.Requestid,patientName :'@a.PatientName'})"> Cancel Case</button>
                                <button class="btn btn-success rounded-5 col-5 m-2 mx-3" onclick="loadActionView({ActionType:'ViewNotes',requestid :@a.Requestid})">View Notes</button>
                                <button class="btn btn-danger rounded-5 col-5 m-2 mx-3" onclick="ShowModal({ActionType:'BlockCase',requestid :@a.Requestid,patientName :'@a.PatientName'})">Block Patient</button>
                                <button class="btn btn-success rounded-5 col-5 m-2 mx-3">Email</button>
                            </div>

                        </div>
                    </div>
                </div>

            }
        }
    </div>
</div>

<div class="d-flex justify-content-between m-2 mb-5">
    <div>
        @Model.entries
    </div>
    <div>
        @{
            if (Model.pageNumber > 1)
            {
                var previousPage = Model.pageNumber - 1;
                <button class="btn btn-outline-secondary" onclick="loadPartialView('new', '@previousPage' ,'@Model.search' , '@Model.regionid')"><i class="bi bi-chevron-left"></i></button>
            }
            else
            {
                <button class="btn btn-outline-secondary"><i class="bi bi-chevron-left"></i></button>
            }
        }

        <button class="btn btn-outline-info">@Model.pageNumber</button>
        @{
            if (Model.morePages == true)
            {
                var nextpage = Model.pageNumber + 1;
                <button class="btn btn-outline-secondary" onclick="loadPartialView('new', '@nextpage' ,'@Model.search' , '@Model.regionid')"><i class="bi bi-chevron-right"></i></button>
            }
            else
            {
                <button class="btn btn-outline-secondary"><i class="bi bi-chevron-right"></i></button>
            }
        }
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.7.1.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script >

    function adminDashload(dataObject) {

        $.ajax({
            url: '/' + dataObject.controller + '/' + dataObject.actionType,
            type: 'POST',
            data: dataObject,
            success: function (data) {
                if(dataObject.actionType  == "AcceptRequest"){
                    if(data == "ok"){
                        toastr.success("Request Is Accepted");
                    }else{
                        toastr.warning("Internanl Error");
                    }
                    loadPartialDashView('dashboard');
                }else{
                    $('#mainDashContent').html(data);
                }

                const dropdownParents = document.querySelectorAll('.nav-link');
                dropdownParents.forEach(parent => {
                    parent.classList.remove('active');
                });
                var ele = document.getElementById(dataObject.id);
                ele.classList.add('active');

            },
            error: function () {
                console.error('Error loading partial view.');
            }
        });
    }

    function ShowModal(DataObject) {
        $.ajax({
            url: '/DashActionView/Openmodal',
            type: 'Post',
            data: DataObject,
            success: function (data) {
                console.log(1)
                $('#partialContainer').html(data);
                $('#myModal').modal('show');
            },
            error: function (e) {
                console.log(e);
            }
        });
    }

    var calltype = "";
    var othercalltype = ""
    function enccounterradio(clickType) {
        if (clickType == "housecall") {
            calltype = "HouseCall";
            othercalltype = "consult";
            
        } else {
            calltype = "Consult";
            othercalltype = "housecall";
        }
        var h = document.getElementById(clickType);
        h.classList.remove("btn-outline-info");
        h.classList.add("btn-info", "text-white");

        var c = document.getElementById(othercalltype);
        c.classList.remove("btn-info", "text-white");
        c.classList.add("btn-outline-info");
    }

    function loadActionView(DataObject) {

        if (DataObject.ActionType == "Encounter") {
                DataObject.callType = calltype;
        }

        console.log(DataObject);

        $.ajax({
            url: '/DashActionView/'+DataObject.ActionType,
            type: 'POST',
            data: DataObject,
            success: function (data) {
                if (data.isfinalized) {
                    ShowModal({ ActionType: 'finalizedencounter' })
                } 
                else if (DataObject.ActionType == "Encounter" || DataObject.ActionType == "TransferToAdmin") {
                    $('#myModal').modal('hide');
                    toastr.success(data);
                    //if (DataObject.ActionType == "TransferToAdmin"){
                    //    loadPartialView('pending', '1');
                    //}else{
                    //    loadPartialView('active', '1');
                    //}
                    window.location.reload();
                }
                else{
                    $('#mainDashContent').html(data);
                }

                if (DataObject.ActionType == "dashboard") {
                    loadPartialView(localStorage.getItem("StatusTab"), '1');
                }

            },
            error: function () {
                console.error('Error loading partial view.');
            }
        });
    }

    function FormSubmitAction(actionType, id, tab) {

        var formdata = $(id).serialize();

        $.ajax({
            url: '/DashActionView/' + actionType,
            type: 'POST',
            data: formdata,
            success: function (data) {
                $('#mainDashContent').html(data);
            },
            error: function () {
                console.error('Error loading partial view.');
            }
        });
    }

    function FormSubmitAction1(actionType, id) {

        var formdata = $(id).serialize();

        $.ajax({
            url: '/AdminDash/' + actionType,
            type: 'POST',
            data: formdata,
            success: function (data) {
                $('#mainDashContent').html(data);
            },
            error: function () {
                console.error('Error loading partial view.');
            }
        });
    }

    function deleteAll(requestid, actionType) {
        var selectedCheck = [];

        var checkboxes = document.querySelectorAll(".custom-check");

        checkboxes.forEach(function (checkbox) {
            if (checkbox.checked) {
                selectedCheck.push(checkbox.value);
            }
        });

        $.ajax({
            url: '/DashActionView/DocumentActions',
            type: 'POST',
            data: { selectedCheck: selectedCheck, requestid: requestid, actionType: actionType },
            success: function (data) {
                if (actionType != 'DownloadAll') {
                    $('#mainDashContent').html(data);
                } else {
                    var blob = new Blob([data], { type: "application/zip" });
                    saveAs(blob, "downloadedDocuments.zip");
                }

            },
            error: function () {
                console.error('Error loading partial view.');
            }
        });

        console.log(selectedCheck);

    }

    function savedoc() {

        var formdata = new FormData();
        var fileupload = document.getElementById('file1');
        var f = fileupload.files[0];
        formdata.append('file1', f);

        console.log(formdata);

        $.ajax({
            url: '/DashActionView/view_uploads',
            type: 'POST',
            data: formdata,
            processData: false,
            contentType: false,
            success: function (data) {
                $('#mainDashContent').html(data);
            },
            error: function () {
                console.error('Error loading partial view.');
            }
        });
    }


    function OpenSwal(Requestid) {

        console.log(Requestid);

        const swalWithBootstrapButtons = Swal.mixin({
            customClass: {
                confirmButton: "btn btn-info m-2",
                cancelButton: "btn btn-outline-info m-2"
            },
            buttonsStyling: false
        });

        swalWithBootstrapButtons.fire({
            title: "Confirmation For Clear Case",
            text: "Are sure you want to clear this request? Once clear this request then you not able to see this request.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Clear",
            cancelButtonText: "Cancel",
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: '/AdminDash/ClearCase',
                    type: 'Post',
                    data: { Requestid: Requestid },
                    success: function (data) {

                    },
                    error: function (e) {
                        console.log(e);
                    }
                });
            }
        });
    }
</script>